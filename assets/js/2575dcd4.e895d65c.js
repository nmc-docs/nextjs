"use strict";(self.webpackChunknextjs=self.webpackChunknextjs||[]).push([[999],{2942:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>i,metadata:()=>c,toc:()=>a});var s=t(4848),r=t(8453);const i={sidebar_position:10},o="Middleware",c={id:"routing/middleware",title:"Middleware",description:"Middleware \u0111\u1ec3 l\xe0m g\xec?",source:"@site/docs/routing/middleware.md",sourceDirName:"routing",slug:"/routing/middleware",permalink:"/nextjs/routing/middleware",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:10,frontMatter:{sidebar_position:10},sidebar:"tutorialSidebar",previous:{title:"Route Handlers",permalink:"/nextjs/routing/route-handlers"},next:{title:"Data fetching",permalink:"/nextjs/category/data-fetching"}},l={},a=[{value:"Middleware \u0111\u1ec3 l\xe0m g\xec?",id:"middleware-\u0111\u1ec3-l\xe0m-g\xec",level:2},{value:"T\u1ea1o middleware",id:"t\u1ea1o-middleware",level:2},{value:"Matching Paths",id:"matching-paths",level:2},{value:"M\u1ed9t s\u1ed1 v\xed d\u1ee5 v\u1ec1 middleware",id:"m\u1ed9t-s\u1ed1-v\xed-d\u1ee5-v\u1ec1-middleware",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"middleware",children:"Middleware"})}),"\n",(0,s.jsx)(n.h2,{id:"middleware-\u0111\u1ec3-l\xe0m-g\xec",children:"Middleware \u0111\u1ec3 l\xe0m g\xec?"}),"\n",(0,s.jsx)(n.admonition,{type:"info",children:(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Trong NextJS, Middleware s\u1ebd \u0111\u01b0\u1ee3c th\u1ef1c hi\u1ec7n tr\u01b0\u1edbc khi v\xe0o m\u1ed9t route. \u1ede \u0111\xe2y ta c\xf3 th\u1ec3 \u0111i\u1ec1u ch\u1ec9nh response nh\u01b0 redirect, rewriting, thay \u0111\u1ed5i request/response headers."}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Middleware s\u1ebd \u0111\u01b0\u1ee3c ch\u1ec9 \u0111\u1ecbnh \u0111\u1ed1i v\u1edbi nh\u1eefng route m\xe0 n\xf3 match (ta t\u1ef1 \u0111\u1ecbnh ngh\u0129a)."}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"M\u1ed9t s\u1ed1 use case m\xe0 \xe1p d\u1ee5ng middleware:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"X\xe1c th\u1ef1c v\xe0 ph\xe2n quy\u1ec1n: Ta c\xf3 th\u1ec3 s\u1eed d\u1ee5ng middleware \u0111\u1ec3 ki\u1ec3m tra xem user c\xf3 \u0111\u01b0\u1ee3c truy c\u1eadp v\xe0o m\u1ed9t private route hay m\u1ed9t route m\xe0 \u0111\u01b0\u1ee3c ph\xe2n quy\u1ec1n hay kh\xf4ng. N\u1ebfu kh\xf4ng ta c\xf3 th\u1ec3 redirect v\u1ec1 trang \u0111\u0103ng nh\u1eadp,..."}),"\n",(0,s.jsx)(n.li,{children:"Ph\xe1t hi\u1ec7n bot: B\u1ea3o v\u1ec7 route b\u1eb1ng c\xe1ch b\u1ea3o v\u1ec7 v\xe0 ch\u1eb7n c\xe1c bot x\xe2m nh\u1eadp tr\xe1i ph\xe9p v\xe0o trang web."}),"\n"]}),"\n"]}),"\n"]})}),"\n",(0,s.jsx)(n.admonition,{type:"note",children:(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["M\u1ed9t s\u1ed1 l\u01b0u \xfd v\u1edbi middleware:","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Middleware kh\xf4ng n\xean x\u1eed l\xfd c\xe1c t\xe1c v\u1ee5 n\u1eb7ng ho\u1eb7c ti\xeau t\u1ed1n nhi\u1ec1u t\xe0i nguy\xean, v\xec middleware s\u1ebd \u0111\u01b0\u1ee3c ch\u1ea1y m\u1ed7i khi ta \u0111i \u0111\u1ebfn m\u1ed9t route."}),"\n",(0,s.jsx)(n.li,{children:"Middleware c\xf3 th\u1ec3 th\u1ef1c hi\u1ec7n c\xe1c thao t\xe1c server-side nh\u01b0ng ta kh\xf4ng n\xean th\u1ef1c hi\u1ec7n c\xe1c thao t\xe1c tr\u1ef1c ti\u1ebfp v\u1edbi database."}),"\n"]}),"\n"]}),"\n"]})}),"\n",(0,s.jsx)(n.h2,{id:"t\u1ea1o-middleware",children:"T\u1ea1o middleware"}),"\n",(0,s.jsx)(n.admonition,{type:"info",children:(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Ta t\u1ea1o file ",(0,s.jsx)(n.strong,{children:"middleware.ts"})," \u1edf c\u1ea5p cao nh\u1ea5t b\xean trong th\u01b0 m\u1ee5c src (c\xf9ng c\u1ea5p v\u1edbi th\u01b0 m\u1ee5c ",(0,s.jsx)(n.strong,{children:"app"}),")"]}),"\n",(0,s.jsxs)(n.li,{children:["\u1ede trong file n\xe0y, ta ",(0,s.jsx)(n.code,{children:"export function middleware"}),", h\xe0m n\xe0y nh\u1eadn 1 tham s\u1ed1 c\xf3 ki\u1ec3u ",(0,s.jsx)(n.a,{href:"../functions/next-request",children:"NextRequest"})," ch\u1ee9a th\xf4ng tin request. \u1ede trong h\xe0m n\xe0y ta c\xf3 th\u1ec3 s\u1eed d\u1ee5ng ",(0,s.jsx)(n.a,{href:"../functions/next-response",children:"NextResponse"})," \u0111\u1ec3 h\u1ed7 tr\u1ee3 vi\u1ec7c \u0111i\u1ec1u h\u01b0\u1edbng."]}),"\n"]})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:'title="src/middleware.ts"',children:'import { NextResponse } from "next/server";\nimport type { NextRequest } from "next/server";\n\n// This function can be marked `async` if using `await` inside\nexport function middleware(request: NextRequest) {\n  return NextResponse.redirect(new URL("/home", request.url));\n}\n\n// See "Matching Paths" below to learn more\nexport const config = {\n  matcher: "/about/:path*",\n};\n'})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\u1ede v\xed d\u1ee5 tr\xean, ta t\u1ea1o middleware ch\u1ec9 \xe1p d\u1ee5ng \u0111\u1ed1i v\u1edbi c\xe1c route ",(0,s.jsx)(n.strong,{children:'"/about/*"'}),", khi user v\xe0o route n\xe0y th\xec s\u1ebd b\u1ecb redirect v\u1ec1 route ",(0,s.jsx)(n.strong,{children:'"/home"'})]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"matching-paths",children:"Matching Paths"}),"\n",(0,s.jsx)(n.admonition,{type:"info",children:(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["M\u1eb7c \u0111\u1ecbnh, middleware s\u1ebd \xe1p d\u1ee5ng cho t\u1ea5t c\u1ea3 c\xe1c route trong app, do \u0111\xf3, ta c\u1ea7n c\u1ea5u h\xecnh ",(0,s.jsx)(n.code,{children:"matcher"})," \u0111\u1ec3 ch\u1ec9 \xe1p d\u1ee5ng middleware \u0111\u1ed1i v\u1edbi m\u1ed9t s\u1ed1 route c\u1ee5 th\u1ec3."]}),"\n",(0,s.jsxs)(n.li,{children:["\u0110\u1ec3 t\u1ea1o matcher, ta ",(0,s.jsx)(n.code,{children:"export"})," m\u1ed9t ",(0,s.jsx)(n.code,{children:"config"})," \u1edf file ",(0,s.jsx)(n.strong,{children:"middleware.ts"})]}),"\n"]})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:'title="src/middleware.ts"',children:'export const config = {\n  matcher: "/about/:path*",\n};\n'})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Ta c\xf3 th\u1ec3 ch\u1ec9 \u0111\u1ecbnh m\u1ed9t ho\u1eb7c nhi\u1ec1u path:"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:'title="src/middleware.ts"',children:'export const config = {\n  matcher: ["/about/:path*", "/dashboard/:path*"],\n};\n'})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"matcher"})," c\u0169ng c\xf3 h\u1ed7 tr\u1ee3 regex:"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:'title="src/middleware.ts"',children:'export const config = {\n  matcher: [\n    /*\n     * \xc1p d\u1ee5ng middleware cho t\u1ea5t c\u1ea3 c\xe1c route ngo\u1ea1i tr\u1eeb nh\u1eefng route b\u1eaft \u0111\u1ea7u b\u1eb1ng:\n     * - api (API routes)\n     * - _next/static (static files)\n     * - _next/image (image optimization files)\n     * - favicon.ico, sitemap.xml, robots.txt (metadata files)\n     */\n    "/((?!api|_next/static|_next/image|favicon.ico|sitemap.xml|robots.txt).*)",\n  ],\n};\n'})}),"\n",(0,s.jsx)(n.admonition,{type:"note",children:(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["M\u1ed9t s\u1ed1 l\u01b0u \xfd khi thi\u1ebft l\u1eadp ",(0,s.jsx)(n.code,{children:"matcher"}),":","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"PH\u1ea2I"})," b\u1eaft \u0111\u1ea7u b\u1eb1ng ",(0,s.jsx)(n.code,{children:"/"})]}),"\n",(0,s.jsxs)(n.li,{children:["C\xf3 th\u1ec3 bao g\u1ed3m parameter nh\u01b0 ",(0,s.jsx)(n.code,{children:"/about/:path"})," s\u1ebd kh\u1edbp v\u1edbi c\xe1c route ",(0,s.jsx)(n.code,{children:"/about/a"}),", ",(0,s.jsx)(n.code,{children:"/about/b"})," nh\u01b0ng s\u1ebd kh\xf4ng kh\u1edbp v\u1edbi route ",(0,s.jsx)(n.code,{children:"/about/a/c"})]}),"\n",(0,s.jsxs)(n.li,{children:["C\xf3 th\u1ec3 c\xf3 modifiers \u1edf parameter: ",(0,s.jsx)(n.code,{children:"/about/:path*"}),", n\xf3 s\u1ebd match v\u1edbi route ",(0,s.jsx)(n.code,{children:"/about/a/b/c"})," v\xec trong regex, ",(0,s.jsx)(n.code,{children:"*"})," kh\u1edbp 0 ho\u1eb7c nhi\u1ec1u l\u1ea7n, ",(0,s.jsx)(n.code,{children:"?"})," kh\u1edbp 0 ho\u1eb7c 1 l\u1ea7n, ",(0,s.jsx)(n.code,{children:"+"})," kh\u1edbp 1 ho\u1eb7c nhi\u1ec1u l\u1ea7n."]}),"\n"]}),"\n"]}),"\n"]})}),"\n",(0,s.jsx)(n.h2,{id:"m\u1ed9t-s\u1ed1-v\xed-d\u1ee5-v\u1ec1-middleware",children:"M\u1ed9t s\u1ed1 v\xed d\u1ee5 v\u1ec1 middleware"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u0110i\u1ec1u h\u01b0\u1edbng c\xf3 \u0111i\u1ec1u ki\u1ec7n:"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:'title="src/middleware.ts"',children:'import { NextResponse } from "next/server";\nimport type { NextRequest } from "next/server";\n\nexport function middleware(request: NextRequest) {\n  if (request.nextUrl.pathname.startsWith("/about")) {\n    return NextResponse.rewrite(new URL("/about-2", request.url));\n  }\n\n  if (request.nextUrl.pathname.startsWith("/dashboard")) {\n    return NextResponse.rewrite(new URL("/dashboard/user", request.url));\n  }\n}\n'})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Thao t\xe1c v\u1edbi cookies:"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:'title="src/middleware.ts"',children:'import { NextResponse } from "next/server";\nimport type { NextRequest } from "next/server";\n\nexport function middleware(request: NextRequest) {\n  // Assume a "Cookie:nextjs=fast" header to be present on the incoming request\n  // Getting cookies from the request using the `RequestCookies` API\n  let cookie = request.cookies.get("nextjs");\n  console.log(cookie); // => { name: \'nextjs\', value: \'fast\', Path: \'/\' }\n  const allCookies = request.cookies.getAll();\n  console.log(allCookies); // => [{ name: \'nextjs\', value: \'fast\' }]\n\n  request.cookies.has("nextjs"); // => true\n  request.cookies.delete("nextjs");\n  request.cookies.has("nextjs"); // => false\n\n  // Setting cookies on the response using the `ResponseCookies` API\n  const response = NextResponse.next();\n  response.cookies.set("vercel", "fast");\n  response.cookies.set({\n    name: "vercel",\n    value: "fast",\n    path: "/",\n  });\n  cookie = response.cookies.get("vercel");\n  console.log(cookie); // => { name: \'vercel\', value: \'fast\', Path: \'/\' }\n  // The outgoing response will have a `Set-Cookie:vercel=fast;path=/` header.\n\n  return response;\n}\n'})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Thao t\xe1c v\u1edbi headers:"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:'title="src/middleware.ts"',children:'import { NextResponse } from "next/server";\nimport type { NextRequest } from "next/server";\n\nexport function middleware(request: NextRequest) {\n  // Clone the request headers and set a new header `x-hello-from-middleware1`\n  const requestHeaders = new Headers(request.headers);\n  requestHeaders.set("x-hello-from-middleware1", "hello");\n\n  // You can also set request headers in NextResponse.next\n  const response = NextResponse.next({\n    request: {\n      // New request headers\n      headers: requestHeaders,\n    },\n  });\n\n  // Set a new response header `x-hello-from-middleware2`\n  response.headers.set("x-hello-from-middleware2", "hello");\n  return response;\n}\n'})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"X\u1eed l\xfd CORS khi g\u1ecdi \u0111\u1ebfn c\xe1c API:"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",metastring:'title="src/middleware.ts"',children:'import { NextRequest, NextResponse } from "next/server";\n\nconst allowedOrigins = ["https://acme.com", "https://my-app.org"];\n\nconst corsOptions = {\n  "Access-Control-Allow-Methods": "GET, POST, PUT, DELETE, OPTIONS",\n  "Access-Control-Allow-Headers": "Content-Type, Authorization",\n};\n\nexport function middleware(request: NextRequest) {\n  // Check the origin from the request\n  const origin = request.headers.get("origin") ?? "";\n  const isAllowedOrigin = allowedOrigins.includes(origin);\n\n  // Handle preflighted requests\n  const isPreflight = request.method === "OPTIONS";\n\n  if (isPreflight) {\n    const preflightHeaders = {\n      ...(isAllowedOrigin && { "Access-Control-Allow-Origin": origin }),\n      ...corsOptions,\n    };\n    return NextResponse.json({}, { headers: preflightHeaders });\n  }\n\n  // Handle simple requests\n  const response = NextResponse.next();\n\n  if (isAllowedOrigin) {\n    response.headers.set("Access-Control-Allow-Origin", origin);\n  }\n\n  Object.entries(corsOptions).forEach(([key, value]) => {\n    response.headers.set(key, value);\n  });\n\n  return response;\n}\n\nexport const config = {\n  matcher: "/api/:path*",\n};\n'})})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>c});var s=t(6540);const r={},i=s.createContext(r);function o(e){const n=s.useContext(i);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),s.createElement(i.Provider,{value:n},e.children)}}}]);